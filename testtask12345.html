<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>설문/음성 실험</title>
  <!-- jsPsych 및 Survey 플러그인 등 필수 라이브러리 로드 -->
  <script src="https://unpkg.com/jspsych@8.2.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey@2.0.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@2.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" />
  <!-- Firebase SDK (CDN) 불러오기 -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <style>
    html, body, .jspsych-content, .sv-root, .sv-question__title, .sv-string-viewer, input, select, button {
      font-size: 1.25rem !important; line-height: 1.5 !important;
    }
    #progress-indicator {
      position: fixed; top: 12px; right: 18px; z-index: 9999;
      font-size: 2.2em; font-weight: bold; color: #333;
      background: rgba(255,255,255,0.8); padding: 2px 10px; border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08); pointer-events: none; user-select: none;
    }
    .sv-description { font-size: 0.98em; color: #666; margin-top: 4px; margin-bottom: 8px; white-space: pre-line;}
    .sd-action__title, .sv-action-bar-item.sv-action-bar-item--icon.sv-dots__item,
    .sd-action[title="Clear"], .sv-clear-button, .sv-dropdown__button { display: none !important; }
    .sv_q_radiogroup { display: block !important; }
    .sv_q_rating .sv-string-viewer { display: none !important; }
  </style>
</head>
<body>
  <div id="progress-indicator"></div>
</body>
<script>
// 자극 파일명 배열(실험에 맞게 수정)
const stimuli = [
  "stim1.wav", "stim2.wav", "stim3.wav"
];

/********************************************************
  1. [여기]에 본인 Firebase 콘솔에서 복사한 firebaseConfig 붙여넣기
********************************************************/
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCBoY3ewkkl6VxFtkbFZkzuVolpIDnhtZI",
  authDomain: "perception-test-kang.firebaseapp.com",
  databaseURL: "https://perception-test-kang-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "perception-test-kang",
  storageBucket: "perception-test-kang.firebasestorage.app",
  messagingSenderId: "686724960923",
  appId: "1:686724960923:web:3df683b4546dbafea82c3e"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// 설문 시작 전 응답 개수 체크(30명 제한)
db.ref('responses').once('value').then(function(snapshot) {
  const responseCount = snapshot.numChildren();
  if (responseCount >= 30) {
    document.body.innerHTML = `
      <div style="padding:2em; font-size:1.3em; text-align:center;">
        <b>설문이 마감되었습니다.</b><br>
        정원(30명)이 모두 참여하여 더 이상 응답을 받을 수 없습니다.<br>
        참여해주셔서 감사합니다!
      </div>
    `;
  } else {
    runExperiment();
  }
});

function runExperiment() {
  const jsPsych = initJsPsych({
    on_finish: function() {
      const trials = jsPsych.data.get().filter({trial_tag: 'audio_trial'}).values();
      const account = jsPsych.data.get().filter({trial_tag: 'account_info'}).last(1).values()[0];
      db.ref('responses').push({
        trials: trials,
        name: account?.ptp_name || "",
        account: account?.ptp_account || "",
        timestamp: new Date().toISOString()
      });
    }
  });

  const timeline = [];

  // 안내문
  timeline.push({
    type: 'html-button-response',
    stimulus: `<h2>설문 안내</h2><p>실험 안내문구 등 ㅋㅋ하이요...</p>`,
    choices: ['시작'],
    on_start: function() {
      document.getElementById('progress-indicator').innerText = '';
    }
  });

  // 자극 셔플
  const shuffled = jsPsych.randomization.shuffle(stimuli);

  shuffled.forEach((audiofile, idx) => {

    // 설문 문항 블록(jsPsychSurvey)
    timeline.push({
      type: 'survey',
      survey_json: {
        elements: [
          {
            type: "html",
            name: "audio_" + idx,
            html: `
              <p>음성 파일을 들어주세요.<br>실험입니다</p>
              <audio controls>
                <source src="${audiofile}" type="audio/wav">
                브라우저가 오디오 태그를 지원하지 않습니다.
              </audio>
              <hr>
            `
          },
          {
            type: "text",
            name: "age",
            title: "몇 살처럼 들리나요?",
            description: "(안녕",
            inputType: "number",
            min: 10,
            max: 99,
            isRequired: true,
            requiredErrorText: "이 문항은 반드시 숫자로 입력해주세요.",
            validators: [
              {
                type: "numeric",
                text: "이 문항은 반드시 숫자로 입력해주세요."
              }
            ]
          },
          {
            type: "radiogroup",
            name: "dialect_like",
            title: "맞짱뜨까?",
            choices: ["예", "아니요"],
            isRequired: true,
            requiredErrorText: "반드시 선택해주세요."
          },
          {
            type: "radiogroup",
            name: "dialect_region",
            title: "어디서볼래?",
            choices: ["옥상", "학교", "경찰서"],
            isRequired: true,
            requiredErrorText: "지역을 선택해주세요.",
            visibleIf: "{dialect_like} = '예'"
          },
          {
            type: "rating",
            name: "naturalness",
            title: "얼마나 싸움을 잘하시나요?",
            rateMin: 1,
            rateMax: 5,
            isRequired: true,
            minRateDescription: "",
            maxRateDescription: "",
            rateValues: [
              { value: 1, text: "완전 못함" },
              { value: 2, text: "조금 자신없음" },
              { value: 3, text: "중간" },
              { value: 4, text: "조금 쏌ㅋ" },
              { value: 5, text: "매우 강함" }
            ],
            displayMode: "buttons",
            colCount: 5,
            requiredErrorText: "이 문항을 꼭 선택해주세요."
          }
        ]
      },
      button_label_finish: "다음",
      data: { audio_file: audiofile, trial_tag: 'audio_trial' }
    });

    // (선택) 슬라이더 task
    timeline.push({
      type: 'html-slider-response',
      stimulus: '<p>제가 만만한가요?</p>',
      labels: ['전혀', '보통', '매우', '개무서움'],
      min: 0,
      max: 100,
      slider_start: 50,
      step: 1,
      require_movement: true,
      button_label: '다음',
      data: { audio_file: audiofile, trial_tag: 'slider_trial' }
    });

    // (선택) 좌우키 응답 task
    timeline.push({
      type: 'html-keyboard-response',
      stimulus: `
        <p>아래 소리를 들어보고, 도끼: <b>왼쪽 SHIFT</b>, 토끼: <b>오른쪽 SHIFT</b> 키를 눌러 선택해 주세요.</p>
        <audio id="stim-audio" controls autoplay>
          <source src="${audiofile}" type="audio/wav">
          브라우저가 오디오 태그를 지원하지 않습니다.
        </audio>
      `,
      choices: ['shiftleft','shiftright'],
      prompt: "<p>[왼쪽 SHIFT] = 도끼&nbsp;&nbsp;|&nbsp;&nbsp;[오른쪽 SHIFT] = 토끼</p>",
      on_finish: function(data){
        if(data.key_press === 16 && data.response === 'shiftleft'){
          data.choice_label = "도끼";
        } else if(data.key_press === 16 && data.response === 'shiftright'){
          data.choice_label = "토끼";
        }
      },
      data: { audio_file: audiofile, trial_tag: 'key_trial' }
    });
  });

  // [3] 참가자 인적정보 등 입력
  timeline.push({
    type: 'survey',
    survey_json: {
      elements: [
        { type: "text", name: "ptp_name", title: "이름", isRequired: true },
        { type: "text", name: "ptp_account", title: "계좌번호", isRequired: true }
      ]
    },
    button_label_finish: "제출",
    data: { trial_tag: "account_info" }
  });

  // [4] 설문 종료 안내
  timeline.push({
    type: 'html-button-response',
    stimulus: "<h2>설문 완료</h2><p>참여해주셔서 감사합니다.</p>",
    choices: ['종료']
  });

  jsPsych.run(timeline);
}
</script>
</html>
