<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>설문/음성 실험</title>
  <!-- jsPsych 및 주요 플러그인 불러오기 -->
  <script src="https://unpkg.com/jspsych@8.2.1"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@2.1.2"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.2.0"></script>
  <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css" rel="stylesheet" />
  <!-- Firebase SDK (CDN) - compat 버전만 사용 -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  <style>
    html, body, .jspsych-content, input, select, button {
      font-size: 1.25rem !important; line-height: 1.5 !important;
    }
    #progress-indicator {
      position: fixed; top: 12px; right: 18px; z-index: 9999;
      font-size: 2.2em; font-weight: bold; color: #333;
      background: rgba(255,255,255,0.8); padding: 2px 10px; border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08); pointer-events: none; user-select: none;
    }
  </style>
</head>
<body>
  <div id="progress-indicator"></div>
</body>
<script>
const stimuli = ["stim1.wav", "stim2.wav", "stim3.wav"];

/********************************************************
  최신 Firebase config로 compat 방식 초기화!
********************************************************/
const firebaseConfig = {
  apiKey: "AIzaSyCBoY3ewkkl6VxFtkbFZkzuVolpIDnhtZI",
  authDomain: "perception-test-kang.firebaseapp.com",
  databaseURL: "https://perception-test-kang-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "perception-test-kang",
  storageBucket: "perception-test-kang.firebasestorage.app",
  messagingSenderId: "686724960923",
  appId: "1:686724960923:web:3df683b4546dbafea82c3e"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// 설문 시작 전 응답 개수 체크(30명 제한)
db.ref('responses').once('value').then(function(snapshot) {
  const responseCount = snapshot.numChildren();
  if (responseCount >= 30) {
    document.body.innerHTML = `
      <div style="padding:2em; font-size:1.3em; text-align:center;">
        <b>설문이 마감되었습니다.</b><br>
        정원(30명)이 모두 참여하여 더 이상 응답을 받을 수 없습니다.<br>
        참여해주셔서 감사합니다!
      </div>
    `;
  } else {
    runExperiment();
  }
});

function runExperiment() {
  const jsPsych = initJsPsych({
    on_finish: function() {
      const trials = jsPsych.data.get().filter({trial_tag: 'audio_trial'}).values();
      const account = jsPsych.data.get().filter({trial_tag: 'account_info'}).last(1).values()[0];
      db.ref('responses').push({
        trials: trials,
        name: account?.ptp_name || "",
        account: account?.ptp_account || "",
        timestamp: new Date().toISOString()
      });
    }
  });

  const timeline = [];
  // 안내문
  timeline.push({
    type: 'html-button-response',
    stimulus: `<h2>설문 안내</h2>
      <p>여러 음성파일을 듣고 문항에 답하는 실험입니다.<br>
      "시작" 버튼을 누르면 계속 진행됩니다.</p>`,
    choices: ['시작'],
    on_start: function() {
      document.getElementById('progress-indicator').innerText = '';
    }
  });

  const shuffled = jsPsych.randomization.shuffle(stimuli);
  shuffled.forEach((audiofile, idx) => {
    // 메인 설문(HTML 폼 기반)
    timeline.push({
      type: 'survey-html-form',
      preamble: `
        <b>${idx + 1} / ${stimuli.length}</b><br>
        <audio controls>
          <source src="${audiofile}" type="audio/wav">
          [브라우저가 오디오 태그를 지원하지 않습니다.]
        </audio>
        <hr>`,
      html: `
        <label>몇 살처럼 들리나요? 
          <input name="age" type="number" min="10" max="99" required>
        </label><br><br>
        <label>맞짱뜨까? 
          <select name="dialect_like" required>
            <option value="">선택</option>
            <option>예</option>
            <option>아니요</option>
          </select>
        </label><br><br>
        <label>어디서볼래?
          <select name="dialect_region" required>
            <option value="">선택</option>
            <option>옥상</option>
            <option>학교</option>
            <option>경찰서</option>
          </select>
        </label><br><br>
        <label>얼마나 싸움을 잘하시나요? (1=완전 못함 ~ 5=매우 강함) 
          <input type="range" name="naturalness" min="1" max="5" step="1" required>
        </label>
      `,
      button_label: "다음",
      data: { audio_file: audiofile, trial_tag: 'audio_trial' }
    });

    timeline.push({
      type: 'html-slider-response',
      stimulus: '<p>제가 만만한가요?</p>',
      labels: ['전혀', '보통', '매우', '개무서움'],
      min: 0, max: 100, slider_start: 50, step: 1,
      require_movement: true,
      button_label: '다음',
      data: { audio_file: audiofile, trial_tag: 'slider_trial' }
    });

    timeline.push({
      type: 'html-keyboard-response',
      stimulus: `
        <p>아래 소리를 들어보고, 도끼: <b>왼쪽 SHIFT</b>, 토끼: <b>오른쪽 SHIFT</b> 키를 눌러 선택해 주세요.</p>
        <audio id="stim-audio" controls autoplay>
          <source src="${audiofile}" type="audio/wav">
          브라우저가 오디오 태그를 지원하지 않습니다.
        </audio>
      `,
      choices: ['shiftleft','shiftright'],
      prompt: "<p>[왼쪽 SHIFT] = 도끼&nbsp;&nbsp;|&nbsp;&nbsp;[오른쪽 SHIFT] = 토끼</p>",
      on_finish: function(data){
        if(data.key_press === 16 && data.response === 'shiftleft'){
          data.choice_label = "도끼";
        } else if(data.key_press === 16 && data.response === 'shiftright'){
          data.choice_label = "토끼";
        }
      },
      data: { audio_file: audiofile, trial_tag: 'key_trial' }
    });
  });

  // 참가자 인적정보 입력
  timeline.push({
    type: 'survey-html-form',
    preamble: '<b>본인 정보 입력</b>',
    html: `
      <label>이름: <input name="ptp_name" type="text" required></label><br>
      <label>계좌번호: <input name="ptp_account" type="text" required></label>
    `,
    button_label: "제출",
    data: { trial_tag: "account_info" }
  });

  // 설문/실험 종료 안내
  timeline.push({
    type: 'html-button-response',
    stimulus: "<h2>설문 완료</h2><p>참여해주셔서 감사합니다.</p>",
    choices: ['종료']
  });

  jsPsych.run(timeline);
}
</script>
</html>
